generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id               String    @id @default(cuid())
  email            String    @unique
  password         String
  role             String
  isActive         Boolean   @default(true)
  isDeleted        Boolean   @default(false)
  isLocked         Boolean   @default(false)
  lockReason       String?
  refreshToken     String?
  resetToken       String?
  resetTokenExpiry DateTime?
  passwordChangedAt DateTime?
  mustChangePassword Boolean @default(false)
  failedLoginAttempts Int    @default(0)
  lastFailedLoginAt DateTime?
  lastLoginAt      DateTime?
  lastLogoutAt     DateTime?
  emailVerifiedAt  DateTime?
  twoFactorEnabled Boolean   @default(false)
  twoFactorSecret  String?
  backupCodes      String?
  sessionId        String?
  ipAddress        String?
  userAgent        String?
  loginCount       Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?

  profile       Profile?
  patient       Patient?
  doctor        Doctor?
  officer       Officer?
  notifications Notification[]
  sessions      UserSession[]
  loginHistory  LoginHistory[]

  @@map("users")
}

model UserSession {
  id          String   @id @default(cuid())
  userId      String
  sessionId   String   @unique
  ipAddress   String?
  userAgent   String?
  isActive    Boolean  @default(true)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model LoginHistory {
  id          String   @id @default(cuid())
  userId      String?
  email       String
  ipAddress   String?
  userAgent   String?
  success     Boolean
  failReason  String?
  location    String?
  device      String?
  createdAt   DateTime @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("login_history")
}

model Profile {
  id          String   @id @default(cuid())
  userId      String   @unique
  firstName   String
  lastName    String
  phone       String?
  avatar      String?
  dateOfBirth DateTime?
  gender      String?
  address     String?
  city        String?
  state       String?
  zipCode     String?
  country     String   @default("US")
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("profiles")
}

model Patient {
  id                String        @id @default(cuid())
  userId            String        @unique
  patientId         String        @unique
  emergencyContact  String?
  emergencyPhone    String?
  bloodGroup        String?
  allergies         String?
  chronicConditions String?
  insuranceNumber   String?
  insuranceProvider String?
  status            String @default("UNASSIGNED")
  isDeleted         Boolean       @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  deletedAt         DateTime?

  user            User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments    Appointment[]
  vitals          Vital[]
  medicalHistory  MedicalHistory[]
  prescriptions   Prescription[]
  assignedDoctors DoctorPatientAssignment[]

  @@map("patients")
}

model Doctor {
  id              String   @id @default(cuid())
  userId          String   @unique
  doctorId        String   @unique
  specialization  String
  licenseNumber   String   @unique
  experience      Int
  consultationFee Float
  qualification   String?
  hospital        String?
  isAvailable     Boolean  @default(true)
  isDeleted       Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  deletedAt       DateTime?

  user             User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments     Appointment[]
  prescriptions    Prescription[]
  assignedPatients DoctorPatientAssignment[]
  vitalsRecorded   Vital[]                   @relation("VitalRecordedBy")

  @@map("doctors")
}

model Officer {
  id          String   @id @default(cuid())
  userId      String   @unique
  officerId   String   @unique
  department  String?
  position    String?
  isDeleted   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("officers")
}

model DoctorPatientAssignment {
  id         String    @id @default(cuid())
  doctorId   String
  patientId  String
  assignedBy String?
  assignedAt DateTime  @default(now())
  unassignedAt DateTime?
  isActive   Boolean   @default(true)
  isDeleted  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@unique([doctorId, patientId])
  @@map("doctor_patient_assignments")
}

model Appointment {
  id            String            @id @default(cuid())
  patientId     String
  doctorId      String
  scheduledAt   DateTime
  completedAt   DateTime?
  duration      Int               @default(30)
  status        String @default("SCHEDULED")
  meetLink      String?
  notes         String?
  diagnosis     String?
  followUpDate  DateTime?
  cancelReason  String?
  isDeleted     Boolean           @default(false)
  createdAt     DateTime          @default(now())
  updatedAt     DateTime          @updatedAt
  deletedAt     DateTime?

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("appointments")
}

model Vital {
  id         String    @id @default(cuid())
  patientId  String
  doctorId   String?
  type       String
  value      String
  unit       String
  recordedBy String
  recordedAt DateTime  @default(now())
  notes      String?
  isDeleted  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  deletedAt  DateTime?

  patient        Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  recordedByUser Doctor? @relation("VitalRecordedBy", fields: [doctorId], references: [id])

  @@map("vitals")
}

model MedicalHistory {
  id          String    @id @default(cuid())
  patientId   String
  condition   String
  diagnosis   String
  treatment   String?
  severity    String?
  diagnosedAt DateTime
  resolvedAt  DateTime?
  isActive    Boolean   @default(true)
  isDeleted   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)

  @@map("medical_history")
}

model Prescription {
  id           String             @id @default(cuid())
  patientId    String
  doctorId     String
  medication   String
  dosage       String
  frequency    String
  duration     String
  instructions String?
  status       String @default("ACTIVE")
  startDate    DateTime           @default(now())
  endDate      DateTime?
  prescribedAt DateTime           @default(now())
  isDeleted    Boolean            @default(false)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  deletedAt    DateTime?

  patient Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  doctor  Doctor  @relation(fields: [doctorId], references: [id], onDelete: Cascade)

  @@map("prescriptions")
}

model Notification {
  id         String             @id @default(cuid())
  userId     String
  type       String
  status     String @default("PENDING")
  title      String
  message    String
  isRead     Boolean            @default(false)
  readAt     DateTime?
  sentAt     DateTime?
  scheduledAt DateTime?
  metadata   String?
  isDeleted  Boolean            @default(false)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  deletedAt  DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notifications")
}

model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  resource  String
  details   String?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("audit_logs")
}